<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Auctions</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f4f8fb;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 36px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 32px 28px 36px 28px;
        }
        .header {
            border-bottom: 2px solid #e3e3e3;
            margin-bottom: 28px;
            padding-bottom: 18px;
        }
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 2rem;
            color: #2e86de;
        }
        .header-details {
            color: #444;
            font-size: 1.08rem;
        }
        .start-auction-form {
            margin-top: 18px;
            margin-bottom: 32px;
            background: #f8fbff;
            border: 1px solid #e0e7ef;
            border-radius: 8px;
            padding: 18px 22px;
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .start-auction-form label {
            font-weight: 500;
            color: #1b4f72;
            margin-right: 8px;
        }
        .start-auction-form select,
        .start-auction-form input[type="number"] {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #bcd0ee;
            font-size: 1rem;
            margin-right: 12px;
        }
        .start-auction-form input[type="number"] {
            width: 80px;
        }
        .start-auction-form button {
            background: #2e86de;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 18px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .start-auction-form button:hover {
            background: #1b4f72;
        }
        .auctions-list {
            margin-top: 18px;
        }
        .auction-card {
            background: #f8fbff;
            border: 1px solid #e0e7ef;
            border-radius: 8px;
            margin-bottom: 18px;
            padding: 18px 22px;
            display: flex;
            align-items: flex-start;
            gap: 18px;
        }
        .auction-image {
            width: 110px;
            height: 110px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #dbeafe;
            background: #eaf1fa;
        }
        .auction-details {
            flex: 1;
        }
        .auction-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1b4f72;
            margin-bottom: 6px;
        }
        .auction-meta {
            color: #555;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        .auction-meta span {
            display: inline-block;
            margin-right: 18px;
        }
        .no-auctions {
            color: #888;
            font-size: 1.1rem;
            margin-top: 24px;
            text-align: center;
        }
        .dashboard-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(90deg, #2e86de 0%, #6dd5ed 100%);
            color: #fff;
            border: none;
            border-radius: 25px;
            padding: 10px 28px;
            font-size: 1.08rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(46,134,222,0.10);
            text-decoration: none;
            margin-bottom: 24px;
            margin-top: 8px;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            cursor: pointer;
        }
        .dashboard-btn:hover {
            background: linear-gradient(90deg, #1b4f72 0%, #2980b9 100%);
            box-shadow: 0 4px 16px rgba(46,134,222,0.18);
            transform: translateY(-2px) scale(1.03);
            color: #fff;
        }
        .dark-mode-toggle {
            background: none;
            border: none;
            outline: none;
            cursor: pointer;
            font-size: 1.7rem;
            margin-left: 18px;
            color: #2e86de;
            border-radius: 50%;
            transition: background 0.2s, color 0.2s;
            padding: 6px 10px;
        }
        .dark-mode-toggle:hover {
            background: rgba(46,134,222,0.10);
            color: #ffe066;
        }
        body.dark-mode {
            background: #181c24;
            color: #f1f1f1;
        }
        body.dark-mode .container {
            background: #232a36;
            color: #f1f1f1;
            box-shadow: 0 2px 12px rgba(0,0,0,0.25);
        }
        body.dark-mode .header {
            border-bottom: 2px solid #232a36;
            color: #ffe066;
        }
        body.dark-mode .auction-card {
            background: #232a36;
            color: #f1f1f1;
            box-shadow: 0 2px 12px rgba(0,0,0,0.18);
        }
        body.dark-mode .auction-title {
            color: #ffe066;
        }
        body.dark-mode .start-auction-form {
            background: #232a36;
            color: #f1f1f1;
            border: 1px solid #34495e;
        }
        body.dark-mode .start-auction-form label {
            color: #ffe066;
        }
        body.dark-mode .start-auction-form input,
        body.dark-mode .start-auction-form select {
            background: #232a36;
            color: #f1f1f1;
            border: 1px solid #34495e;
        }
        body.dark-mode .start-auction-form button {
            background: #ffe066;
            color: #232a36;
        }
        body.dark-mode .start-auction-form button:hover {
            background: #ffd700;
            color: #181c24;
        }
        body.dark-mode .dashboard-btn {
            background: linear-gradient(90deg, #232a36 0%, #2e86de 100%);
            color: #ffe066;
        }
        body.dark-mode .dashboard-btn:hover {
            background: linear-gradient(90deg, #1b4f72 0%, #2980b9 100%);
            color: #fff;
        }
        body.dark-mode .winner-details {
            background: #232a36 !important;
            border: 2px solid #ffe066 !important;
            box-shadow: 0 4px 12px rgba(255, 224, 102, 0.08) !important;
        }
        body.dark-mode .winner-details h4,
        body.dark-mode .winner-details h5 {
            color: #ffe066 !important;
        }
        body.dark-mode .winner-details p,
        body.dark-mode .winner-details strong,
        body.dark-mode .winner-details span {
            color: #f1f1f1 !important;
        }
        body.dark-mode .winner-details .bid-info,
        body.dark-mode .winner-details .contact-info,
        body.dark-mode .winner-details > div[style*='background: white'],
        body.dark-mode .winner-details > div[style*='background: #f8f9fa'],
        body.dark-mode .winner-details div[style*='background: white'],
        body.dark-mode .winner-details div[style*='background: #f8f9fa'] {
            background: #181c24 !important;
            color: #f1f1f1 !important;
            border: 1px solid #34495e !important;
        }
        body.dark-mode .winner-details h5 {
            color: #ffe066 !important;
            border-bottom: 2px solid #ffe066 !important;
        }
        body.dark-mode .winner-details a {
            color: #ffe066 !important;
            background: #232a36 !important;
            border: 1px solid #ffe066 !important;
        }
        body.dark-mode .winner-details a:hover {
            background: #ffe066 !important;
            color: #232a36 !important;
        }
        @media (max-width: 700px) {
            .container {
                padding: 12px 2vw 18px 2vw;
            }
            .auction-card {
                flex-direction: column;
                align-items: stretch;
            }
            .auction-image {
                width: 100%;
                height: 180px;
                margin-bottom: 10px;
            }
            .start-auction-form {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>My Auctions</h1>
            <div class="header-details">
                <strong>Name:</strong> <%= supplier && supplier.name ? supplier.name : "Unknown" %> <br>
                <strong>Supplier ID:</strong> <%= supplier && supplier.supplierId ? supplier.supplierId : "N/A" %> <br>
            </div>
            <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle dark mode">
                <span id="darkModeIcon">üåô</span>
            </button>
        </div>
        <a href="/supplier" class="dashboard-btn">
            <span style="font-size:1.3em;">üè†</span> Back to Dashboard
        </a>

        <!-- Start Auction Form -->
        <form class="start-auction-form" action="/supplier/startAuction" method="POST">
            <label for="auctionId">Select Auction:</label>
            <select name="auctionId" id="auctionId" required>
                <option value="" disabled selected>Select auction</option>
                <% if (auctions && auctions.length > 0) { %>
                    <% auctions.forEach(function(auction) { %>
                        <option value="<%= auction._id %>"><%= auction.name %></option>
                    <% }); %>
                <% } %>
            </select>
            <label for="duration">Duration (minutes):</label>
            <input type="number" name="duration" id="duration" min="1" max="1440" required placeholder="e.g. 30">
            <button type="submit">Start Auction</button>
        </form>

        <div class="auctions-list">
            <% if (auctions && auctions.length > 0) { %>
                <% auctions.forEach(function(auction) { %>
                    <div class="auction-card" id="auction-<%= auction._id %>">
                        <% if (auction.image) { %>
                            <img class="auction-image" src="<%= auction.image %>" alt="Auction Image">
                        <% } else { %>
                            <div class="auction-image" style="display:flex;align-items:center;justify-content:center;color:#aaa;font-size:0.95rem;">No Image</div>
                        <% } %>
                        <div class="auction-details">
                            <div class="auction-title">
                                <%= auction.name %>
                                <% if (auction.isLive && auction.auctionEnd && new Date(auction.auctionEnd) > new Date()) { %>
                                    <span style="color: #e74c3c; font-size: 0.9rem; margin-left: 10px;">üî¥ LIVE</span>
                                <% } else if (auction.isLive && auction.auctionEnd && new Date(auction.auctionEnd) <= new Date()) { %>
                                    <span style="color: #6c757d; font-size: 0.9rem; margin-left: 10px;">üü¢ ENDED</span>
                                <% } %>
                            </div>
                            <div class="auction-meta">
                                <span><strong>Base Price:</strong> ‚Çπ<%= auction.basePrice %></span>
                                <span><strong>Quantity:</strong> <%= auction.quantity %></span>
                                <% if (auction.isLive) { %>
                                    <span><strong>Current Bid:</strong> ‚Çπ<span id="current-bid-<%= auction._id %>"><%= auction.currentBid || auction.basePrice %></span></span>
                                <% } %>
                            </div>
                            <div class="auction-meta">
                                <span><strong>Area:</strong> <%= auction.area ? auction.area : "N/A" %></span>
                                <span><strong>City:</strong> <%= auction.city ? auction.city : "N/A" %></span>
                                <span><strong>State:</strong> <%= auction.state ? auction.state : "N/A" %></span>
                            </div>
                            <div class="auction-meta">
                                <span><strong>Supplier Name:</strong> <%= auction.supplierName %></span>
                                <% if (auction.isLive && auction.auctionEnd) { %>
                                    <span><strong>Ends:</strong> <span id="end-time-<%= auction._id %>"><%= new Date(auction.auctionEnd).toLocaleString() %></span></span>
                                <% } %>
                            </div>
                            <% if (auction.isLive && auction.auctionEnd && new Date(auction.auctionEnd) > new Date()) { %>
                                <div class="auction-meta">
                                    <span><strong>Status:</strong> <span style="color: #e74c3c;">Live Auction</span></span>
                                    <span><strong>Bidders:</strong> <span id="bidders-count-<%= auction._id %>"><%= auction.bidders ? auction.bidders.length : 0 %></span></span>
                                </div>
                            <% } else if (auction.isLive && auction.auctionEnd && new Date(auction.auctionEnd) <= new Date()) { %>
                                <div class="auction-meta">
                                    <span><strong>Status:</strong> <span style="color: #6c757d;">Auction Ended</span></span>
                                    <span><strong>Bidders:</strong> <span id="bidders-count-<%= auction._id %>"><%= auction.bidders ? auction.bidders.length : 0 %></span></span>
                                </div>
                                
                                <!-- Winner Details Section -->
                                <% if (auction.currentBidder && auction.bidders && auction.bidders.length > 0) { %>
                                    <div class="winner-details" style="background: linear-gradient(135deg, #f8fff9, #e8f5e8); border: 2px solid #28a745; border-radius: 12px; padding: 20px; margin-top: 20px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.1);">
                                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                            <div style="background: #28a745; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1.2rem;">
                                                üèÜ
                                            </div>
                                            <div>
                                                <h4 style="color: #28a745; margin: 0; font-size: 1.3rem; font-weight: 600;">Winning Bidder</h4>
                                                <p style="color: #6c757d; margin: 5px 0 0 0; font-size: 0.9rem;">Auction completed successfully</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Bid Information -->
                                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #e9ecef;">
                                            <h5 style="color: #495057; margin: 0 0 12px 0; font-size: 1.1rem; border-bottom: 2px solid #28a745; padding-bottom: 5px;">üìä Bid Information</h5>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 0.95rem;">
                                                <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">
                                                    <strong style="color: #495057;">Winner Name:</strong><br>
                                                    <span style="color: #28a745; font-weight: 600;"><%= auction.currentBidder %></span>
                                                </div>
                                                <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">
                                                    <strong style="color: #495057;">Winning Bid:</strong><br>
                                                    <span style="color: #28a745; font-weight: 600;">‚Çπ<%= auction.currentBid %></span>
                                                </div>
                                                <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">
                                                    <strong style="color: #495057;">Bid Time:</strong><br>
                                                    <span style="color: #6c757d;"><%= auction.bidders[auction.bidders.length - 1].bidTime ? new Date(auction.bidders[auction.bidders.length - 1].bidTime).toLocaleString() : 'N/A' %></span>
                                                </div>
                                                <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px;">
                                                    <strong style="color: #495057;">Total Bids:</strong><br>
                                                    <span style="color: #6c757d;"><%= auction.bidders.length %></span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Contact Information -->
                                        <div style="background: white; border-radius: 8px; padding: 15px; border: 1px solid #e9ecef;">
                                            <h5 style="color: #495057; margin: 0 0 12px 0; font-size: 1.1rem; border-bottom: 2px solid #007bff; padding-bottom: 5px;">üìû Contact Information</h5>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; font-size: 0.95rem;">
                                                <div style="background: #f8f9fa; padding: 10px 12px; border-radius: 6px; border-left: 4px solid #007bff;">
                                                    <strong style="color: #495057;">Vendor ID:</strong><br>
                                                    <span style="color: #007bff; font-weight: 500;"><%= auction.bidders[auction.bidders.length - 1].vendorId || 'N/A' %></span>
                                                </div>
                                                <div style="background: #f8f9fa; padding: 10px 12px; border-radius: 6px; border-left: 4px solid #28a745;">
                                                    <strong style="color: #495057;">Phone:</strong><br>
                                                    <a href="tel:<%= auction.bidders[auction.bidders.length - 1].vendorPhone || '' %>" style="color: #28a745; text-decoration: none; font-weight: 500;"><%= auction.bidders[auction.bidders.length - 1].vendorPhone || 'N/A' %></a>
                                                </div>
                                                <div style="background: #f8f9fa; padding: 10px 12px; border-radius: 6px; border-left: 4px solid #ffc107;">
                                                    <strong style="color: #495057;">Email:</strong><br>
                                                    <a href="mailto:<%= auction.bidders[auction.bidders.length - 1].vendorEmail || '' %>" style="color: #ffc107; text-decoration: none; font-weight: 500;"><%= auction.bidders[auction.bidders.length - 1].vendorEmail || 'N/A' %></a>
                                                </div>
                                                <div style="background: #f8f9fa; padding: 10px 12px; border-radius: 6px; border-left: 4px solid #6f42c1; grid-column: 1 / -1;">
                                                    <strong style="color: #495057;">Address:</strong><br>
                                                    <span style="color: #6f42c1; font-weight: 500;"><%= auction.bidders[auction.bidders.length - 1].vendorAddress || 'N/A' %></span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                            <a href="tel:<%= auction.bidders[auction.bidders.length - 1].vendorPhone || '' %>" style="background: #28a745; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 5px;">
                                                üìû Call Winner
                                            </a>
                                            <a href="mailto:<%= auction.bidders[auction.bidders.length - 1].vendorEmail || '' %>" style="background: #007bff; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 5px;">
                                                ‚úâÔ∏è Email Winner
                                            </a>
                                            <a href="https://wa.me/<%= auction.bidders[auction.bidders.length - 1].vendorPhone || '' %>" target="_blank" style="background: #25d366; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 5px;">
                                                üí¨ WhatsApp
                                            </a>
                                        </div>
                                    </div>
                                <% } %>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="no-auctions">
                    You have not listed any auctions yet.
                </div>
            <% } %>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // Listen for auction started events
        socket.on('auctionStarted', (data) => {
            // Update the auction card to show live status
            const auctionCard = document.getElementById(`auction-${data.auctionId}`);
            if (auctionCard) {
                const title = auctionCard.querySelector('.auction-title');
                if (title && !title.innerHTML.includes('üî¥ LIVE')) {
                    title.innerHTML += ' <span style="color: #e74c3c; font-size: 0.9rem; margin-left: 10px;">üî¥ LIVE</span>';
                }
                
                // Add live auction details
                const details = auctionCard.querySelector('.auction-details');
                if (details) {
                    const metaDiv = details.querySelector('.auction-meta');
                    if (metaDiv) {
                        const currentBidSpan = document.createElement('span');
                        currentBidSpan.innerHTML = `<strong>Current Bid:</strong> ‚Çπ<span id="current-bid-${data.auctionId}">${data.basePrice}</span>`;
                        metaDiv.appendChild(currentBidSpan);
                    }
                }
            }
        });

        // Listen for new bids
        socket.on('newBid', (data) => {
            const currentBidElement = document.getElementById(`current-bid-${data.auctionId}`);
            if (currentBidElement) {
                currentBidElement.textContent = data.bidAmount;
                // Add a visual indicator for new bid
                currentBidElement.style.color = '#e74c3c';
                currentBidElement.style.fontWeight = 'bold';
                setTimeout(() => {
                    currentBidElement.style.color = '';
                    currentBidElement.style.fontWeight = '';
                }, 2000);
            }
        });

        // Listen for auction ended
        socket.on('auctionEnded', (data) => {
            const auctionCard = document.getElementById(`auction-${data.auctionId}`);
            if (auctionCard) {
                const title = auctionCard.querySelector('.auction-title');
                if (title) {
                    title.innerHTML = title.innerHTML.replace('üî¥ LIVE', 'üü¢ ENDED');
                }
            }
        });
    </script>
    <script>
        // Dark mode toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        function setDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
                darkModeIcon.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                darkModeIcon.textContent = 'üåô';
            }
        }
        // Load preference
        const darkPref = localStorage.getItem('darkMode') === 'true';
        setDarkMode(darkPref);
        darkModeToggle.addEventListener('click', () => {
            const enabled = !document.body.classList.contains('dark-mode');
            setDarkMode(enabled);
            localStorage.setItem('darkMode', enabled);
        });
    </script>
</body>
</html>
